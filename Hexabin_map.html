<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>India AQI Hexbin Map</title>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-hexbin@0.2.2/build/d3-hexbin.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #fafafa;
}

#container {
  width: 100%;
  max-width: 1000px;
  margin: auto;
  padding: 10px;
  position: relative;
}

.tooltip {
  position: absolute;
  background: #ffffff;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 13px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  pointer-events: none;
  opacity: 0;
}

.legend {
  font-size: 12px;
}
</style>
</head>

<body>

<div id="container">
  <svg id="map"></svg>
  <div class="tooltip" id="tooltip"></div>
</div>

<script>

const container = document.getElementById("container");
const width = container.clientWidth;
const height = width * 0.85;

const svg = d3.select("#map")
  .attr("viewBox", `0 0 ${width} ${height}`)
  .style("width", "100%")
  .style("height", "auto");

const g = svg.append("g");
const tooltip = d3.select("#tooltip");

// ------------------
// CPCB AQI Colors
// ------------------
function aqiColor(aqi) {
  if (aqi <= 50) return "#009966";
  if (aqi <= 100) return "#ffde33";
  if (aqi <= 200) return "#ff9933";
  if (aqi <= 300) return "#cc0033";
  if (aqi <= 400) return "#660099";
  return "#7e0023";
}

// ------------------
// Projection
// ------------------
const projection = d3.geoMercator()
  .center([82.8, 22.5])
  .scale(width * 1.2)
  .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);

// ------------------
// Tooltip Positioning
// ------------------
function moveTooltip(event) {
  const tooltipWidth = 180;
  const tooltipHeight = 90;

  const x = Math.min(event.pageX + 10, window.innerWidth - tooltipWidth);
  const y = Math.min(event.pageY - 20, window.innerHeight - tooltipHeight);

  tooltip.style("left", x + "px")
         .style("top", y + "px");
}

// ------------------
// Load India Map
// ------------------
d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
.then(world => {

  const india = world.features.filter(d => d.properties.name === "India");

  g.selectAll("path")
    .data(india)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("fill", "#f0f0f0")
    .attr("stroke", "#999")
    .attr("stroke-width", 0.7);

  // ------------------
  // Load CSV Data
  // ------------------
  d3.csv("data.csv").then(data => {

    data = data.map(d => {
      const coords = projection([+d.lon, +d.lat]);
      if (!coords) return null;

      return {
        city: d.city,
        state: d.state,
        x: coords[0],
        y: coords[1],
        aqi: +d.aqi
      };
    }).filter(d => d);

    const hexbin = d3.hexbin()
      .x(d => d.x)
      .y(d => d.y)
      .radius(width < 500 ? 12 : 20)
      .extent([[0, 0], [width, height]]);

    const bins = hexbin(data);

    g.selectAll(".hex")
      .data(bins)
      .enter()
      .append("path")
      .attr("class", "hex")
      .attr("d", d => "M" + d.x + "," + d.y + hexbin.hexagon())
      .attr("fill", d => {
        const avg = d3.mean(d, p => p.aqi);
        return aqiColor(avg);
      })
      .attr("stroke", "#fff")
      .attr("stroke-width", 1)
      .attr("opacity", 0.9)
      .on("mousemove", function(event, d){
        const avg = Math.round(d3.mean(d, p => p.aqi));
        tooltip.style("opacity", 1)
               .html(
                "<strong>Cities:</strong> " + d.length +
                "<br><strong>Avg AQI:</strong> " + avg +
                "<br><small>" + d.map(c => c.city).join(", ") + "</small>"
               );
        moveTooltip(event);
      })
      .on("mouseout", function(){
        tooltip.style("opacity", 0);
      })
      .on("touchstart", function(event, d){
        event.preventDefault();
        const avg = Math.round(d3.mean(d, p => p.aqi));
        tooltip.style("opacity", 1)
               .html(
                "<strong>Cities:</strong> " + d.length +
                "<br><strong>Avg AQI:</strong> " + avg +
                "<br><small>" + d.map(c => c.city).join(", ") + "</small>"
               );
        moveTooltip(event.touches[0]);
      });

    // ------------------
    // Legend
    // ------------------
    const legendData = [
      {label:"Good", color:"#009966"},
      {label:"Satisfactory", color:"#ffde33"},
      {label:"Moderate", color:"#ff9933"},
      {label:"Poor", color:"#cc0033"},
      {label:"Very Poor", color:"#660099"},
      {label:"Severe", color:"#7e0023"}
    ];

    const legend = svg.append("g")
      .attr("class", "legend")
      .attr("transform", `translate(20,${height - 130})`);

    legend.selectAll("rect")
      .data(legendData)
      .enter()
      .append("rect")
      .attr("x", 0)
      .attr("y", (d,i)=> i*18)
      .attr("width", 14)
      .attr("height", 14)
      .attr("fill", d=>d.color);

    legend.selectAll("text")
      .data(legendData)
      .enter()
      .append("text")
      .attr("x", 20)
      .attr("y", (d,i)=> i*18 + 11)
      .text(d=>d.label);

  });

});

</script>

</body>
</html>